name: Export Docker Image as WSL Tar

on:
  workflow_dispatch:

jobs:
  export-wsl:
    name: Export Docker image to WSL tar
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Docker
      - name: Setup Docker
        uses: setup-buildx-action@v3

      # Step 3: Pull Docker image
      - name: Pull Docker image
        run: docker pull convisaas/electron-vue-cap-azswa:latest

      # Step 4: Create temporary container
      - name: Create container
        run: docker create --name temp_container convisaas/electron-vue-cap-azswa:latest

      # Step 5: Export container filesystem
      - name: Export container as tar
        run: |
          mkdir output
          docker export temp_container -o output/convisaas-wsl.tar

      # Step 6: Cleanup container
      - name: Remove temporary container
        run: docker rm temp_container

      # Step 7: Verify exported tar
      - name: Verify exported file
        run: |
          dir output
          tar -tf output\convisaas-wsl.tar | Select-Object -First 20

      # Step 8: Upload artifact for workflow
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: convisaas-wsl-rootfs
          path: output/convisaas-wsl.tar
          retention-days: 0

      # Step 9: Create GitHub release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v1.0.0  # You can change or make this dynamic
          release_name: "WSL Export v1.0.0"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 10: Upload tar to the release
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: output/convisaas-wsl.tar
          asset_name: convisaas-wsl.tar
          asset_content_type: application/x-tar
